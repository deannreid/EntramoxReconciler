<!-- ================================================================
  File    : entramox_rules.xml
  Purpose : Entramox Reconciler rules (compat: no correlations,
            rules key off Entramox decoders / base decoder regex)
================================================================ -->

<!-- ================= RECONCILER (entramoxreconciler) ================= -->
<group name="local,entramox,reconciler,">

  <!-- ---------------- Auth / Graph / Token ---------------- -->

  <rule id="2600" level="10">
    <decoded_as>entramox-reconciler-graph-creds-missing</decoded_as>
    <description>Entramox: Graph credentials missing (tenant/client/secret not set)</description>
    <mitre><id>T1552</id></mitre>
    <group>entramox,auth,misconfig,</group>
  </rule>

  <rule id="2601" level="9">
    <decoded_as>entramox-reconciler-token-request-failed</decoded_as>
    <description>Entramox: Token request failed (HTTP $(status))</description>
    <group>entramox,auth,graph,error,</group>
  </rule>

  <rule id="2602" level="8">
    <decoded_as>entramox-reconciler-token-response-missing</decoded_as>
    <description>Entramox: Token response missing access_token</description>
    <group>entramox,auth,graph,error,</group>
  </rule>

  <rule id="2603" level="9">
    <decoded_as>entramox-reconciler-graph-call-failed</decoded_as>
    <description>Entramox: Graph call failed ($(http_method)) (HTTP $(status))</description>
    <group>entramox,graph,error,</group>
  </rule>

  <!-- ---------------- Run lifecycle / observability ---------------- -->

  <rule id="2610" level="3">
    <decoded_as>entramox-reconciler-run-start</decoded_as>
    <description>Entramox: Reconcile started</description>
    <group>entramox,run,</group>
  </rule>

  <rule id="2611" level="3">
    <decoded_as>entramox-reconciler-run-finish</decoded_as>
    <description>Entramox: Reconcile finished (result=$(result))</description>
    <group>entramox,run,</group>
  </rule>

  <rule id="2612" level="3">
    <decoded_as>entramox-reconciler-run-stats</decoded_as>
    <description>Entramox: Run stats created=$(created) updated=$(updated) locked=$(locked) unlocked=$(unlocked) deleted=$(deleted) skipped=$(skipped)</description>
    <group>entramox,run,telemetry,</group>
  </rule>

</group>

<!-- ================= ACCOUNT MANAGEMENT ================= -->
<group name="local,entramox,account_management,">

  <!-- User lifecycle -->
  <rule id="2700" level="7">
    <decoded_as>entramox-reconciler-user-create</decoded_as>
    <description>Entramox: Local user created ($(dstuser))</description>
    <group>user,provisioning,entramox,</group>
  </rule>

  <rule id="2701" level="10">
    <decoded_as>entramox-reconciler-user-delete</decoded_as>
    <description>Entramox: Local user deleted (and home) ($(dstuser))</description>
    <group>user,deprovisioning,entramox,</group>
  </rule>

  <!-- Account lock/unlock -->
  <rule id="2710" level="6">
    <decoded_as>entramox-reconciler-user-lock</decoded_as>
    <description>Entramox: Account locked ($(dstuser))</description>
    <group>user,lock,entramox,</group>
  </rule>

  <rule id="2711" level="6">
    <decoded_as>entramox-reconciler-user-unlock</decoded_as>
    <description>Entramox: Account unlocked ($(dstuser))</description>
    <group>user,unlock,entramox,</group>
  </rule>

  <rule id="2712" level="6">
    <decoded_as>entramox-reconciler-initpass</decoded_as>
    <description>Entramox: Initial password set &amp; expired ($(dstuser))</description>
    <group>user,password,entramox,</group>
  </rule>

  <!-- Group membership changes -->
  <rule id="2720" level="6">
    <decoded_as>entramox-reconciler-group-add</decoded_as>
    <description>Entramox: Group membership added ($(dstuser) -> $(group))</description>
    <group>group_membership,entramox,</group>
  </rule>

  <rule id="2721" level="6">
    <decoded_as>entramox-reconciler-group-remove</decoded_as>
    <description>Entramox: Group membership removed ($(dstuser) -> $(group))</description>
    <group>group_membership,entramox,</group>
  </rule>

  <!-- Privilege changes (sudo group specifically) -->
  <rule id="2725" level="9">
    <decoded_as>entramox-reconciler-group-add</decoded_as>
    <match> to group sudo</match>
    <description>Entramox: Privilege grant - user added to sudo ($(dstuser))</description>
    <mitre><id>T1548</id></mitre>
    <group>privilege_escalation,sudo,entramox,</group>
  </rule>

  <rule id="2726" level="8">
    <decoded_as>entramox-reconciler-group-remove</decoded_as>
    <match> from group sudo</match>
    <description>Entramox: Privilege revoked - user removed from sudo ($(dstuser))</description>
    <group>privilege_revocation,sudo,entramox,</group>
  </rule>

  <!-- Sudoers managed file changes -->
  <rule id="2730" level="9">
    <decoded_as>entramox-reconciler-sudoers-update</decoded_as>
    <description>Entramox: Sudoers file updated ($(dstuser) @ $(path))</description>
    <group>sudoers_change,entramox,</group>
  </rule>

  <rule id="2731" level="8">
    <decoded_as>entramox-reconciler-sudoers-remove</decoded_as>
    <description>Entramox: Sudoers file removed ($(dstuser))</description>
    <group>sudoers_change,entramox,</group>
  </rule>

  <rule id="2732" level="9">
    <decoded_as>entramox-reconciler-visudo-fail</decoded_as>
    <description>Entramox: visudo validation failed ($(dstuser))</description>
    <group>sudoers_change,error,entramox,</group>
  </rule>

  <!-- Deprovision lifecycle -->
  <rule id="2740" level="6">
    <decoded_as>entramox-reconciler-not-in-allowgroups</decoded_as>
    <description>Entramox: User not in allow-groups; locked and marked for deletion ($(dstuser))</description>
    <group>deprovisioning,entramox,</group>
  </rule>

  <rule id="2741" level="10">
    <decoded_as>entramox-reconciler-deleted-after-grace</decoded_as>
    <description>Entramox: User deleted after grace period ($(dstuser))</description>
    <group>deprovisioning,entramox,</group>
  </rule>

  <!-- Operational issues -->
  <rule id="2760" level="8">
    <decoded_as>entramox-reconciler-missing-bin</decoded_as>
    <description>Entramox: Missing required binary ($(bin_key) -> $(bin_path))</description>
    <group>operational,entramox,</group>
  </rule>

  <rule id="2765" level="12">
    <decoded_as>entramox-reconciler-exception</decoded_as>
    <description>Entramox: Unhandled exception</description>
    <group>error,exception,entramox,</group>
  </rule>

</group>
