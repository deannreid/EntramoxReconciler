# EntramoxReconciler – Splunk Detection Guide

## Overview

This document provides **Splunk searches, alerting guidance, and deployable saved search templates** for monitoring identity and privilege lifecycle events generated by **entramoxreconciler**, a Proxmox ↔ Entra ID reconciliation service.

The goal is to give Splunk admins **high-signal detections** for:

* Local user creation and deletion
* Account lock/unlock
* Sudo privilege assignment and removal
* Sudoers file changes
* Proxmox (PVE) user enable/disable and metadata changes
* Users entering deletion grace period

---

## Log Sources Assumed

### Required

* Linux authentication logs

  * `/var/log/auth.log` (Debian/Ubuntu)
  * `/var/log/secure` (RHEL/CentOS)
* EntramoxReconciler application log

  * `/var/log/entramoxreconciler/thelog.log`

### Optional (recommended)

* `auditd` logs
* File Integrity Monitoring (FIM) via Wazuh / auditd
* Monitoring of `/etc/sudoers.d/`

---

## Index / Sourcetype Assumptions

Adjust as required:

```text
index=linux
sourcetype=linux_auth OR linux_secure
source=/var/log/entramoxreconciler/thelog.log
```

---

## 1. Local User Created

### Purpose

Detect creation of a local Unix user account.

### Splunk Search

```spl
(index=linux (sourcetype=linux_auth OR sourcetype=linux_secure))
("useradd[" OR "new user:")
| rex field=_raw "new user:\s+name=(?<user>\S+)"
| stats count earliest(_time) as first_seen latest(_time) as last_seen by host user
| convert ctime(first_seen) ctime(last_seen)
```

### Alert Recommendation

* Trigger when `count > 0`
* Severity: **Medium**
* Useful for tracking provisioning drift or abuse

---

## 2. Local User Deleted

### Purpose

Detect deletion of a Unix user (including home removal).

### Splunk Search

```spl
(index=linux (sourcetype=linux_auth OR sourcetype=linux_secure))
("userdel[" OR "deleted user")
| rex field=_raw "deleted user\s+(?<user>\S+)"
| stats count latest(_time) as deleted_at by host user
| convert ctime(deleted_at)
```

### Alert Recommendation

* Severity: **High**
* Especially important outside scheduled deprovision windows

---

## 3. User Locked / Unlocked

### Purpose

Detect account lock or unlock events (`usermod -L / -U`).

### Splunk Search

```spl
(index=linux (sourcetype=linux_auth OR sourcetype=linux_secure))
("usermod[" AND ("lock" OR "unlock" OR "-L" OR "-U"))
| rex field=_raw "usermod\[\d+\]:\s+(?<action>lock|unlock).*'(?<user>[^']+)'"
| stats count latest(_time) as last_seen by host user action
| convert ctime(last_seen)
```

### Alert Recommendation

* Lock: **Medium**
* Unlock: **High** (potential privilege restoration)

---

## 4. User Added to / Removed from Sudo Group

### Purpose

Detect group-based sudo privilege changes.

### Splunk Search

```spl
(index=linux (sourcetype=linux_auth OR sourcetype=linux_secure))
( ("usermod[" AND "sudo") OR ("gpasswd[" AND "sudo") )
| eval action=case(
    like(_raw, "%usermod%") AND like(_raw, "%sudo%"), "sudo_granted",
    like(_raw, "%gpasswd%") AND like(_raw, "%-d%") AND like(_raw, "% sudo%"), "sudo_revoked",
    true(), "unknown"
)
| rex field=_raw "('(?<user>[^']+)'|user\s+(?<user2>\S+))"
| eval user=coalesce(user,user2)
| stats count latest(_time) as last_seen by host user action
| convert ctime(last_seen)
```

### Alert Recommendation

* Grant: **High**
* Revoke: **Medium**
* Include command line context in alert payload

---

## 5. Sudoers File Created / Modified / Removed

### Purpose

Detect direct privilege escalation via `/etc/sudoers.d/`.

### Splunk Search (FIM / auditd)

```spl
(index=linux (sourcetype=auditd OR sourcetype=ossec))
("/etc/sudoers.d/pve_realm-" AND ( "CREATE" OR "WRITE" OR "DELETE" OR "modified" OR "deleted"))
| rex field=_raw "/etc/sudoers\.d/pve_realm-(?<user>[A-Za-z0-9._-]+)"
| eval action=case(
    match(_raw,"DELETE|deleted"), "sudoers_removed",
    match(_raw,"CREATE|created"), "sudoers_created",
    match(_raw,"WRITE|modified"), "sudoers_modified",
    true(), "sudoers_change"
)
| stats count latest(_time) as last_seen by host user action
| convert ctime(last_seen)
```

### Alert Recommendation

* Creation / Modification: **Critical**
* Removal: **Medium**

---

## 6. EntramoxReconciler – User Created (Authoritative)

### Purpose

Detect user creation explicitly driven by Entra reconciliation.

### Splunk Search

```spl
index=linux source="/var/log/entramoxreconciler/thelog.log"
"Created local user:"
| rex "Created local user:\s+(?<user>\S+)"
| stats count latest(_time) as created_at by host user
| convert ctime(created_at)
```

### Why This Matters

This is **high-confidence, expected automation** — useful to suppress noise from raw auth logs.

---

## 7. EntramoxReconciler – User Marked for Deletion (Grace Period)

### Purpose

Detect users removed from Entra allow-groups and entering deletion countdown.

### Splunk Search

```spl
index=linux source="/var/log/entramoxreconciler/thelog.log"
"locked and marked for deletion"
| rex "User\s+(?<user>\S+)\s+not in Entra allow-groups; locked and marked for deletion"
| stats count latest(_time) as marked_at by host user
| convert ctime(marked_at)
```

### Alert Recommendation

* Severity: **Medium**
* Useful for SOC / IAM audit workflows

---

## 8. EntramoxReconciler – Sudo Granted / Revoked

### Purpose

Detect sudo changes initiated by reconciliation logic.

### Splunk Search

```spl
index=linux source="/var/log/entramoxreconciler/thelog.log"
("Updated sudoers for" OR "Removed sudoers file for")
| rex "for\s+(?<user>\S+)"
| eval action=if(match(_raw,"Updated sudoers"),"sudo_granted","sudo_revoked")
| stats count latest(_time) as last_seen by host user action
| convert ctime(last_seen)
```

---

## 9. Proxmox (PVE) User Enabled / Disabled

### Purpose

Track identity state changes inside Proxmox.

### Splunk Search

```spl
index=linux source="/var/log/entramoxreconciler/thelog.log"
"PVE user"
("created" OR "set enable")
| rex "PVE user\s+(?<userid>\S+)"
| rex "enable=(?<enabled>[01])"
| eval state=if(enabled=="1","enabled","disabled")
| stats count latest(_time) as last_seen by host userid state
| convert ctime(last_seen)
```

---

## Recommended Alerting Strategy

| Event                    | Severity | Notes                      |
| ------------------------ | -------- | -------------------------- |
| User created             | Medium   | Expected via automation    |
| User deleted             | High     | Review for timing/context  |
| Sudo granted             | High     | Always alert               |
| Sudoers modified         | Critical | Possible manual escalation |
| User marked for deletion | Medium   | Informational              |
| PVE user disabled        | Medium   | IAM lifecycle              |
| PVE user enabled         | High     | Re-enablement risk         |

---

# Deployable Saved Searches (JSON Source-of-Truth)

This section provides **Saved Search JSON objects** you can manage as a “source of truth” in Git and deploy via automation.

### Important deployment note

Splunk’s REST endpoint for creating saved searches typically expects **form-encoded fields** per search (not a single JSON blob). Use the JSON below as your config, and have your deployment tooling translate each object into form fields for:

`POST /servicesNS/<owner>/<app>/saved/searches`

## Saved Search JSON Bundle

```json
{
  "saved_searches": [
    {
      "name": "ENTRAMOX - Local User Created (authlog)",
      "description": "Detect local Unix user creation events from auth logs.",
      "search": "index=linux (sourcetype=linux_auth OR sourcetype=linux_secure) (\"useradd[\" OR \"new user:\") | rex field=_raw \"new user:\\s+name=(?<user>\\S+)\" | stats count earliest(_time) as first_seen latest(_time) as last_seen by host user | convert ctime(first_seen) ctime(last_seen)",
      "cron_schedule": "*/5 * * * *",
      "dispatch.earliest_time": "-10m",
      "dispatch.latest_time": "now",
      "is_scheduled": 1,
      "alert_type": "number of events",
      "alert_comparator": "greater than",
      "alert_threshold": "0",
      "alert.severity": "3",
      "alert.suppress": "1",
      "alert.suppress.period": "1h"
    },
    {
      "name": "ENTRAMOX - Local User Deleted (authlog)",
      "description": "Detect local Unix user deletion events from auth logs.",
      "search": "index=linux (sourcetype=linux_auth OR sourcetype=linux_secure) (\"userdel[\" OR \"deleted user\") | rex field=_raw \"deleted user\\s+(?<user>\\S+)\" | stats count latest(_time) as deleted_at by host user | convert ctime(deleted_at)",
      "cron_schedule": "*/5 * * * *",
      "dispatch.earliest_time": "-10m",
      "dispatch.latest_time": "now",
      "is_scheduled": 1,
      "alert_type": "number of events",
      "alert_comparator": "greater than",
      "alert_threshold": "0",
      "alert.severity": "4",
      "alert.suppress": "1",
      "alert.suppress.period": "2h"
    },
    {
      "name": "ENTRAMOX - User Locked/Unlocked (authlog)",
      "description": "Detect user lock/unlock events via usermod from auth logs.",
      "search": "index=linux (sourcetype=linux_auth OR sourcetype=linux_secure) (\"usermod[\" AND (\"lock\" OR \"unlock\" OR \"-L\" OR \"-U\")) | rex field=_raw \"usermod\\[\\d+\\]:\\s+(?<action>lock|unlock).*'(?<user>[^']+)'\" | stats count latest(_time) as last_seen by host user action | convert ctime(last_seen)",
      "cron_schedule": "*/5 * * * *",
      "dispatch.earliest_time": "-10m",
      "dispatch.latest_time": "now",
      "is_scheduled": 1,
      "alert_type": "number of events",
      "alert_comparator": "greater than",
      "alert_threshold": "0",
      "alert.severity": "3",
      "alert.suppress": "1",
      "alert.suppress.period": "1h"
    },
    {
      "name": "ENTRAMOX - Sudo Granted/Revoked (authlog)",
      "description": "Detect sudo group membership changes via usermod/gpasswd in auth logs.",
      "search": "index=linux (sourcetype=linux_auth OR sourcetype=linux_secure) ((\"usermod[\" AND \"sudo\") OR (\"gpasswd[\" AND \"sudo\")) | eval action=case(like(_raw,\"%usermod%\") AND like(_raw,\"%sudo%\"),\"sudo_granted\", like(_raw,\"%gpasswd%\") AND like(_raw,\"%-d%\") AND like(_raw,\"% sudo%\"),\"sudo_revoked\", true(),\"unknown\") | rex field=_raw \"('(?<user>[^']+)'|user\\s+(?<user2>\\S+))\" | eval user=coalesce(user,user2) | stats count latest(_time) as last_seen by host user action | convert ctime(last_seen)",
      "cron_schedule": "*/5 * * * *",
      "dispatch.earliest_time": "-10m",
      "dispatch.latest_time": "now",
      "is_scheduled": 1,
      "alert_type": "number of events",
      "alert_comparator": "greater than",
      "alert_threshold": "0",
      "alert.severity": "5",
      "alert.suppress": "1",
      "alert.suppress.period": "2h"
    },
    {
      "name": "ENTRAMOX - Sudoers File Changed (/etc/sudoers.d)",
      "description": "Detect CREATE/WRITE/DELETE on /etc/sudoers.d/pve_realm-* via auditd/ossec.",
      "search": "index=linux (sourcetype=auditd OR sourcetype=ossec) \"/etc/sudoers.d/pve_realm-\" (\"CREATE\" OR \"WRITE\" OR \"DELETE\" OR \"modified\" OR \"deleted\") | rex field=_raw \"/etc/sudoers\\.d/pve_realm-(?<user>[A-Za-z0-9._-]+)\" | eval action=case(match(_raw,\"DELETE|deleted\"),\"sudoers_removed\", match(_raw,\"CREATE|created\"),\"sudoers_created\", match(_raw,\"WRITE|modified\"),\"sudoers_modified\", true(),\"sudoers_change\") | stats count latest(_time) as last_seen by host user action | convert ctime(last_seen)",
      "cron_schedule": "*/5 * * * *",
      "dispatch.earliest_time": "-10m",
      "dispatch.latest_time": "now",
      "is_scheduled": 1,
      "alert_type": "number of events",
      "alert_comparator": "greater than",
      "alert_threshold": "0",
      "alert.severity": "6",
      "alert.suppress": "1",
      "alert.suppress.period": "4h"
    },
    {
      "name": "ENTRAMOX - Reconciler: User Created",
      "description": "High-confidence user creation emitted by entramoxreconciler log.",
      "search": "index=linux source=\"/var/log/entramoxreconciler/thelog.log\" \"Created local user:\" | rex \"Created local user:\\s+(?<user>\\S+)\" | stats count latest(_time) as created_at by host user | convert ctime(created_at)",
      "cron_schedule": "*/5 * * * *",
      "dispatch.earliest_time": "-10m",
      "dispatch.latest_time": "now",
      "is_scheduled": 1,
      "alert_type": "number of events",
      "alert_comparator": "greater than",
      "alert_threshold": "0",
      "alert.severity": "3",
      "alert.suppress": "1",
      "alert.suppress.period": "1h"
    },
    {
      "name": "ENTRAMOX - Reconciler: User Marked For Deletion",
      "description": "Detect grace-period lifecycle start from entramoxreconciler log.",
      "search": "index=linux source=\"/var/log/entramoxreconciler/thelog.log\" \"locked and marked for deletion\" | rex \"User\\s+(?<user>\\S+)\\s+not in Entra allow-groups; locked and marked for deletion\" | stats count latest(_time) as marked_at by host user | convert ctime(marked_at)",
      "cron_schedule": "*/5 * * * *",
      "dispatch.earliest_time": "-10m",
      "dispatch.latest_time": "now",
      "is_scheduled": 1,
      "alert_type": "number of events",
      "alert_comparator": "greater than",
      "alert_threshold": "0",
      "alert.severity": "4",
      "alert.suppress": "1",
      "alert.suppress.period": "1h"
    },
    {
      "name": "ENTRAMOX - Reconciler: Sudo Granted/Revoked",
      "description": "Detect reconciler-driven sudoers changes from entramoxreconciler log.",
      "search": "index=linux source=\"/var/log/entramoxreconciler/thelog.log\" (\"Updated sudoers for\" OR \"Removed sudoers file for\") | rex \"for\\s+(?<user>\\S+)\" | eval action=if(match(_raw,\"Updated sudoers\"),\"sudo_granted\",\"sudo_revoked\") | stats count latest(_time) as last_seen by host user action | convert ctime(last_seen)",
      "cron_schedule": "*/5 * * * *",
      "dispatch.earliest_time": "-10m",
      "dispatch.latest_time": "now",
      "is_scheduled": 1,
      "alert_type": "number of events",
      "alert_comparator": "greater than",
      "alert_threshold": "0",
      "alert.severity": "5",
      "alert.suppress": "1",
      "alert.suppress.period": "2h"
    },
    {
      "name": "ENTRAMOX - Reconciler: PVE User Enabled/Disabled",
      "description": "Detect Proxmox user enable/disable actions from reconciler log.",
      "search": "index=linux source=\"/var/log/entramoxreconciler/thelog.log\" \"PVE user\" (\"created\" OR \"set enable\") | rex \"PVE user\\s+(?<userid>\\S+)\" | rex \"enable=(?<enabled>[01])\" | eval state=if(enabled==\"1\",\"enabled\",\"disabled\") | stats count latest(_time) as last_seen by host userid state | convert ctime(last_seen)",
      "cron_schedule": "*/5 * * * *",
      "dispatch.earliest_time": "-10m",
      "dispatch.latest_time": "now",
      "is_scheduled": 1,
      "alert_type": "number of events",
      "alert_comparator": "greater than",
      "alert_threshold": "0",
      "alert.severity": "4",
      "alert.suppress": "1",
      "alert.suppress.period": "2h"
    }
  ]
}
```

---

# Splunk ES Notable Templates (Correlation Search Style)

Use these when you want **Splunk ES Notable Events** instead of (or as well as) “email/alert actions”.

> Depending on your ES version/content tooling, you may implement these via the ES UI (Correlation Searches) and copy the `search` / notable parameters, or manage as code via your preferred content pipeline.

## ES Notable: Sudo Privilege Granted (Critical)

```json
{
  "name": "ES - ENTRAMOX - Sudo Privilege Granted",
  "description": "Triggers a notable when entramoxreconciler grants sudo (sudoers file written or user added to sudo).",
  "search": "index=linux source=\"/var/log/entramoxreconciler/thelog.log\" \"Updated sudoers for\" | rex \"for\\s+(?<user>\\S+)\" | stats latest(_time) as _time by host user | eval signature=\"ENTRAMOX sudo granted\"",
  "cron_schedule": "*/5 * * * *",
  "dispatch.earliest_time": "-10m",
  "dispatch.latest_time": "now",
  "is_scheduled": 1,
  "actions": "notable",
  "action.notable": "1",
  "action.notable.param.rule_title": "ENTRAMOX: Sudo privilege granted",
  "action.notable.param.rule_description": "entramoxreconciler granted sudo access (sudoers updated). Investigate legitimacy and change control reference.",
  "action.notable.param.severity": "critical",
  "action.notable.param.urgency": "high",
  "action.notable.param.default_owner": "secops",
  "action.notable.param.default_status": "1",
  "action.notable.param.drilldown_name": "Host and user context",
  "action.notable.param.drilldown_search": "index=linux host=\"$result.host$\" (\"$result.user$\" OR \"pve_realm-$result.user$\") earliest=-24h"
}
```

## ES Notable: Sudo Privilege Revoked (Medium)

```json
{
  "name": "ES - ENTRAMOX - Sudo Privilege Revoked",
  "description": "Triggers a notable when entramoxreconciler revokes sudo (sudoers removed or user removed from sudo group).",
  "search": "index=linux source=\"/var/log/entramoxreconciler/thelog.log\" \"Removed sudoers file for\" | rex \"for\\s+(?<user>\\S+)\" | stats latest(_time) as _time by host user | eval signature=\"ENTRAMOX sudo revoked\"",
  "cron_schedule": "*/5 * * * *",
  "dispatch.earliest_time": "-10m",
  "dispatch.latest_time": "now",
  "is_scheduled": 1,
  "actions": "notable",
  "action.notable": "1",
  "action.notable.param.rule_title": "ENTRAMOX: Sudo privilege revoked",
  "action.notable.param.rule_description": "entramoxreconciler revoked sudo access. Validate expected deprovision path.",
  "action.notable.param.severity": "medium",
  "action.notable.param.urgency": "medium",
  "action.notable.param.default_owner": "secops",
  "action.notable.param.default_status": "1",
  "action.notable.param.drilldown_search": "index=linux host=\"$result.host$\" \"$result.user$\" earliest=-24h"
}
```

## ES Notable: User Marked for Deletion (High)

```json
{
  "name": "ES - ENTRAMOX - User Marked For Deletion",
  "description": "User removed from allow-groups and entered deletion grace period.",
  "search": "index=linux source=\"/var/log/entramoxreconciler/thelog.log\" \"locked and marked for deletion\" | rex \"User\\s+(?<user>\\S+)\\s+not in Entra allow-groups\" | stats latest(_time) as _time by host user | eval signature=\"ENTRAMOX user marked for deletion\"",
  "cron_schedule": "*/5 * * * *",
  "dispatch.earliest_time": "-10m",
  "dispatch.latest_time": "now",
  "is_scheduled": 1,
  "actions": "notable",
  "action.notable": "1",
  "action.notable.param.rule_title": "ENTRAMOX: User marked for deletion (grace period)",
  "action.notable.param.rule_description": "User fell out of Entra allow-groups. Account locked; deletion countdown started. Verify leaver/mover process.",
  "action.notable.param.severity": "high",
  "action.notable.param.urgency": "high",
  "action.notable.param.default_owner": "iam-ops",
  "action.notable.param.default_status": "1",
  "action.notable.param.drilldown_search": "index=linux host=\"$result.host$\" \"$result.user$\" earliest=-7d"
}
```

## ES Notable: Sudoers File Modified (Critical – audit/FIM)

```json
{
  "name": "ES - ENTRAMOX - Sudoers File Modified",
  "description": "Detects direct modifications to managed sudoers files under /etc/sudoers.d/pve_realm-*.",
  "search": "index=linux (sourcetype=auditd OR sourcetype=ossec) \"/etc/sudoers.d/pve_realm-\" (\"WRITE\" OR \"modified\") | rex \"/etc/sudoers\\.d/pve_realm-(?<user>[A-Za-z0-9._-]+)\" | stats latest(_time) as _time values(_raw) as evidence by host user | eval signature=\"Sudoers file modified\"",
  "cron_schedule": "*/5 * * * *",
  "dispatch.earliest_time": "-10m",
  "dispatch.latest_time": "now",
  "is_scheduled": 1,
  "actions": "notable",
  "action.notable": "1",
  "action.notable.param.rule_title": "Sudoers file modified (managed pve_realm)",
  "action.notable.param.rule_description": "Managed sudoers file changed. Potential manual escalation or tampering. Confirm change control.",
  "action.notable.param.severity": "critical",
  "action.notable.param.urgency": "high",
  "action.notable.param.default_owner": "secops",
  "action.notable.param.default_status": "1",
  "action.notable.param.drilldown_search": "index=linux host=\"$result.host$\" \"/etc/sudoers.d/pve_realm-$result.user$\" earliest=-24h"
}
```

---

## Final Notes for Splunk Admins

* Prefer **script log–based detections** for signal quality
* Use auth/audit logs for **corroboration**, not primary alerting
* Consider suppressing raw `useradd/usermod` alerts when the reconciler log confirms legitimacy
* Time-based dashboards (grace countdowns) are very effective for ops visibility
