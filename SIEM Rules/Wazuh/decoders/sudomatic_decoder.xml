<!-- ================================================================
  File    : entramox_decoder.xml
  Purpose : Program-specific decoders for Entramox Reconciler
  Notes   : All decoders are anchored to program_name '^entramoxreconciler$'
           to avoid collisions with generic python/system decoders.
           Uses OSRegex / POSIX ERE only.
================================================================ -->

<!-- ============================
     ENTRAMOX RECONCILER DECODERS
     (program-specific to avoid collisions)
     ============================ -->

<decoder name="entramox-reconciler">
  <program_name>^entramoxreconciler$</program_name>
  <regex>^(.+)$</regex>
  <order>msg</order>
</decoder>

<!-- ------------------------------------------------
     Credential / Auth / Token handling
     ------------------------------------------------ -->

<decoder name="entramox-reconciler-graph-creds-missing">
  <parent>entramox-reconciler</parent>
  <regex>^Graph creds missing: set one of (.+) or \(([^,]+),([^,]+),([^)]+)\)$</regex>
  <order>token_env_fallbacks, env_tenant_id, env_client_id, env_client_secret</order>
</decoder>

<decoder name="entramox-reconciler-token-request-failed">
  <parent>entramox-reconciler</parent>
  <regex>^Token request failed: status=([0-9]{3}) err=(.+)$</regex>
  <order>status, err</order>
</decoder>

<decoder name="entramox-reconciler-token-response-missing">
  <parent>entramox-reconciler</parent>
  <regex>^Token response missing access_token$</regex>
  <order>msg</order>
</decoder>

<decoder name="entramox-reconciler-graph-call-failed">
  <parent>entramox-reconciler</parent>
  <regex>^Graph call failed: method=([A-Z]+) url=(.+) status=([0-9]{3}) err=(.+)$</regex>
  <order>http_method, url, status, err</order>
</decoder>

<!-- ------------------------------------------------
     Reconcile lifecycle / run status
     ------------------------------------------------ -->

<decoder name="entramox-reconciler-run-start">
  <parent>entramox-reconciler</parent>
  <regex>^Reconcile started(?: run_id=([A-Za-z0-9_.:-]+))?$</regex>
  <order>run_id</order>
</decoder>

<decoder name="entramox-reconciler-run-finish">
  <parent>entramox-reconciler</parent>
  <regex>^Reconcile finished(?: run_id=([A-Za-z0-9_.:-]+))? result=([A-Za-z0-9_.:-]+)$</regex>
  <order>run_id, result</order>
</decoder>

<decoder name="entramox-reconciler-run-stats">
  <parent>entramox-reconciler</parent>
  <regex>^Stats: created=([0-9]+) updated=([0-9]+) locked=([0-9]+) unlocked=([0-9]+) deleted=([0-9]+) skipped=([0-9]+)$</regex>
  <order>created, updated, locked, unlocked, deleted, skipped</order>
</decoder>

<!-- ------------------------------------------------
     User lifecycle / account state
     ------------------------------------------------ -->

<decoder name="entramox-reconciler-user-create">
  <parent>entramox-reconciler</parent>
  <regex>^Created local user: ([A-Za-z0-9_.-]+)$</regex>
  <order>dstuser</order>
</decoder>

<decoder name="entramox-reconciler-user-delete">
  <parent>entramox-reconciler</parent>
  <regex>^Deleted user \(and home\): ([A-Za-z0-9_.-]+)$</regex>
  <order>dstuser</order>
</decoder>

<decoder name="entramox-reconciler-user-lock">
  <parent>entramox-reconciler</parent>
  <regex>^Locked user: ([A-Za-z0-9_.-]+)$</regex>
  <order>dstuser</order>
</decoder>

<decoder name="entramox-reconciler-user-unlock">
  <parent>entramox-reconciler</parent>
  <regex>^Unlocked user: ([A-Za-z0-9_.-]+)$</regex>
  <order>dstuser</order>
</decoder>

<decoder name="entramox-reconciler-initpass">
  <parent>entramox-reconciler</parent>
  <regex>^Initial password set and expired for ([A-Za-z0-9_.-]+) \(not stored\)$</regex>
  <order>dstuser</order>
</decoder>

<!-- ------------------------------------------------
     Group membership / allow-listing
     ------------------------------------------------ -->

<decoder name="entramox-reconciler-group-add">
  <parent>entramox-reconciler</parent>
  <regex>^Added ([A-Za-z0-9_.-]+) to group ([A-Za-z0-9_.-]+)$</regex>
  <order>dstuser, group</order>
</decoder>

<decoder name="entramox-reconciler-group-remove">
  <parent>entramox-reconciler</parent>
  <regex>^Removed ([A-Za-z0-9_.-]+) from group ([A-Za-z0-9_.-]+)$</regex>
  <order>dstuser, group</order>
</decoder>

<decoder name="entramox-reconciler-not-in-allowgroups">
  <parent>entramox-reconciler</parent>
  <regex>^User ([A-Za-z0-9_.-]+) not in Entra allow-groups; locked and marked for deletion in (.+)$</regex>
  <order>dstuser, ttl</order>
</decoder>

<decoder name="entramox-reconciler-deleted-after-grace">
  <parent>entramox-reconciler</parent>
  <regex>^User ([A-Za-z0-9_.-]+) disabled for >= .+; deleting$</regex>
  <order>dstuser</order>
</decoder>

<!-- ------------------------------------------------
     Sudoers / privilege management
     ------------------------------------------------ -->

<decoder name="entramox-reconciler-sudoers-update">
  <parent>entramox-reconciler</parent>
  <regex>^Updated sudoers for ([A-Za-z0-9_.-]+) at (.+)$</regex>
  <order>dstuser, path</order>
</decoder>

<decoder name="entramox-reconciler-sudoers-remove">
  <parent>entramox-reconciler</parent>
  <regex>^Removed sudoers file for ([A-Za-z0-9_.-]+)$</regex>
  <order>dstuser</order>
</decoder>

<decoder name="entramox-reconciler-visudo-fail">
  <parent>entramox-reconciler</parent>
  <regex>^visudo validation failed for ([A-Za-z0-9_.-]+): (.+)$</regex>
  <order>dstuser, err</order>
</decoder>

<!-- ------------------------------------------------
     Operational / dependency checks
     ------------------------------------------------ -->

<decoder name="entramox-reconciler-missing-bin">
  <parent>entramox-reconciler</parent>
  <regex>^Missing required binary: ([A-Za-z0-9_.-]+) -> (.+)$</regex>
  <order>bin_key, bin_path</order>
</decoder>

<decoder name="entramox-reconciler-exception">
  <parent>entramox-reconciler</parent>
  <regex>^Unhandled exception: (.+)$</regex>
  <order>err</order>
</decoder>
